{% set hero_block = (content.blocks | selectattr('type', 'equalto', 'hero') | list | first) %}
{% set derived_title = content.meta_title or (hero_block.title if hero_block and hero_block.title else 'Renewed Website') %}
{% set derived_description = content.meta_description %}
{% if not derived_description %}
  {% if hero_block and hero_block.body %}
    {% set derived_description = hero_block.body | striptags | truncate(160) %}
  {% elif content.blocks|length %}
    {% set derived_description = content.blocks[0].body | striptags | truncate(160) %}
  {% endif %}
{% endif %}
{% set header_subtitle = None %}
{% if hero_block and hero_block.data is mapping %}
  {% set header_subtitle = hero_block.data.get('tagline') or hero_block.data.get('subtitle') %}
{% endif %}
{% set footer_contact = (content.blocks | selectattr('type', 'equalto', 'contact') | list | first) %}
{% set page_meta = {
  'lang': content.language if content.language is defined else 'en',
  'title': derived_title,
  'description': derived_description,
  'canonical': content.canonical_url if content.canonical_url is defined else None,
  'open_graph': {
    'title': derived_title,
    'description': derived_description,
    'type': 'website'
  },
  'twitter': {
    'card': 'summary_large_image',
    'title': derived_title,
    'description': derived_description
  }
} %}
<!DOCTYPE html>
<html lang="{{ page_meta.lang or 'en' }}">
  {% include '_head.jinja' %}
  <body class="{{ (framework.body_class ~ ' d-flex flex-column min-vh-100 bg-body-tertiary') | trim }}">
    {% set header_title = derived_title %}
    {% include '_header.jinja' with context %}
    <main id="main-content" class="flex-grow-1 py-5">
      {% if content.fallback_used %}
      <div class="container mb-5">
        <div class="alert alert-warning shadow-sm" role="status">
          Automatischer LLM-Text fehlt für diese Seite. Bitte Inhalte manuell nachbearbeiten.
        </div>
      </div>
      {% endif %}
      {% for block in content.blocks %}
        {% set partial = section_partials.get(block.type, section_partials['text']) %}
        {% include partial with context %}
      {% endfor %}
      {% if generated_pages %}
      <section class="section py-5">
        <div class="container">
          <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
              <div class="section-shell">
                <h2 class="h3 mb-4">Weitere Seiten</h2>
                <ul class="generated-pages list-unstyled row gy-4">
                  {% for page in generated_pages %}
                  <li class="col-12 col-md-6">
                    <a class="card h-100 text-decoration-none p-4" href="{{ page.href }}">
                      <span class="fw-semibold text-body">{{ page.title }}</span>
                      <span class="text-primary d-inline-flex align-items-center gap-2 mt-2">Seite öffnen<span aria-hidden="true">→</span></span>
                    </a>
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>
      {% endif %}
    </main>
    {% include '_footer.jinja' with context %}
    {% for src in framework.js_links %}
    <script src="{{ src }}" defer></script>
    {% endfor %}
    {% if page_meta.js_links is iterable %}
      {% for src in page_meta.js_links %}
    <script src="{{ src }}" defer></script>
      {% endfor %}
    {% endif %}
  </body>
</html>
