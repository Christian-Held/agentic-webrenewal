{% set brand = header_title | default('Renewed Website') %}
{% set contact_block = footer_contact if footer_contact is defined else None %}
{% set contact_data = contact_block.data if contact_block and contact_block.data is mapping else {} %}
{% set raw_entries = contact_data.get('items') %}
{% if raw_entries is mapping %}
  {% set raw_entries = raw_entries.items() %}
{% endif %}
{% if raw_entries is not iterable %}
  {% set raw_entries = [] %}
{% endif %}
{% set contact_ns = namespace(address=[], info=[]) %}
{% for entry in raw_entries %}
  {% if entry is mapping %}
    {% set label = entry.label %}
    {% set value = entry.value %}
  {% elif entry is sequence and entry|length == 2 %}
    {% set label = entry[0] %}
    {% set value = entry[1] %}
  {% else %}
    {% set label = None %}
    {% set value = None %}
  {% endif %}
  {% if label and value %}
    {% set lower_label = label|lower %}
    {% if 'address' in lower_label or 'adresse' in lower_label %}
      {% if value is string %}
        {% for part in value.split('\n') %}
          {% if part %}
            {% set contact_ns.address = contact_ns.address + [part] %}
          {% endif %}
        {% endfor %}
      {% else %}
        {% set contact_ns.address = contact_ns.address + [value] %}
      {% endif %}
    {% else %}
      {% set contact_ns.info = contact_ns.info + [(label, value)] %}
    {% endif %}
  {% endif %}
{% endfor %}
{% for key, value in contact_data.items() %}
  {% if key not in ['items', 'cta_label', 'cta_href', 'cta_text', 'cta_url'] and value %}
    {% set formatted_key = key|replace('_', ' ')|title %}
    {% if 'address' in key|lower %}
      {% if value is string %}
        {% for part in value.split('\n') %}
          {% if part %}
            {% set contact_ns.address = contact_ns.address + [part] %}
          {% endif %}
        {% endfor %}
      {% else %}
        {% set contact_ns.address = contact_ns.address + [value] %}
      {% endif %}
    {% else %}
      {% set contact_ns.info = contact_ns.info + [(formatted_key, value)] %}
    {% endif %}
  {% endif %}
{% endfor %}
{% if not contact_ns.address and contact_block and contact_block.body %}
  {% for line in contact_block.body.split('\n') %}
    {% if line %}
      {% set contact_ns.address = contact_ns.address + [line] %}
    {% endif %}
  {% endfor %}
{% endif %}
{% set social_keywords = ['facebook', 'linkedin', 'instagram', 'twitter', 'youtube', 'xing', 'tiktok'] %}
{% set legal_keywords = ['impressum', 'privacy', 'datenschutz', 'legal', 'agb', 'terms'] %}
{% set legal_ns = namespace(items=[]) %}
{% set social_ns = namespace(items=[]) %}
{% if navigation %}
  {% for item in navigation recursive %}
    {% set lower = item.label|lower %}
        {% for keyword in legal_keywords %}
      {% if keyword in lower %}
        {% set legal_ns.items = legal_ns.items + [item] %}
        {% break %}
      {% endif %}
    {% endfor %}
    {% for keyword in social_keywords %}
      {% if keyword in lower %}
        {% set social_ns.items = social_ns.items + [{'label': item.label, 'href': item.href}] %}
        {% break %}
      {% endif %}
    {% endfor %}
    {% if item.children %}
      {{ loop(item.children) }}
    {% endif %}
  {% endfor %}
{% endif %}
{% for pair in contact_ns.info %}
  {% set label = pair[0] %}
  {% set value = pair[1] %}
  {% if value is string %}
    {% set value_lower = value|lower %}
    {% for keyword in social_keywords %}
      {% if keyword in value_lower %}
        {% set social_ns.items = social_ns.items + [{'label': label, 'href': value}] %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}
<footer class="site-footer mt-auto py-5">
  <div class="container">
    <div class="row gy-4">
      <div class="col-12 col-lg-4">
        <p class="fs-5 fw-semibold mb-3">{{ brand }}</p>
        {% if contact_ns.address %}
        <address class="mb-0 text-white-50">
          {% for line in contact_ns.address %}
          <div>{{ line }}</div>
          {% endfor %}
        </address>
        {% else %}
        <p class="text-white-50 mb-0">Adresse wird nach dem Import ergänzt.</p>
        {% endif %}
      </div>
      <div class="col-12 col-md-4 col-lg-3">
        <p class="fw-semibold text-uppercase small text-white-50 mb-3">Kontakt</p>
        {% if contact_ns.info %}
        <ul class="list-unstyled mb-0">
          {% for pair in contact_ns.info %}
          <li class="mb-2 contact-item">
            <span class="d-block text-white-50 small">{{ pair[0] }}</span>
            {% if pair[1] is string and pair[1].startswith('http') %}
            <a class="link-light text-decoration-none" href="{{ pair[1] }}">{{ pair[1] }}</a>
            {% else %}
            <span>{{ pair[1] }}</span>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-white-50 mb-0">Kontaktinformationen folgen automatisiert.</p>
        {% endif %}
      </div>
      <div class="col-12 col-md-4 col-lg-5">
        <div class="row g-3">
          <div class="col-12 col-sm-6">
            <p class="fw-semibold text-uppercase small text-white-50 mb-3">Rechtliches</p>
            {% if legal_ns.items %}
            <ul class="list-unstyled mb-0">
              {% for item in legal_ns.items %}
              <li class="mb-2">
                <a class="link-light text-decoration-none" href="{{ item.href }}">{{ item.label }}</a>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-white-50 mb-0">Impressum & Datenschutz werden ergänzt.</p>
            {% endif %}
          </div>
          <div class="col-12 col-sm-6">
            <p class="fw-semibold text-uppercase small text-white-50 mb-3">Social</p>
            {% if social_ns.items %}
            <ul class="list-unstyled mb-0">
              {% for social in social_ns.items %}
              <li class="mb-2">
                <a class="link-light text-decoration-none" href="{{ social.href }}" rel="noopener">{{ social.label }}</a>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p class="text-white-50 mb-0">Social-Media-Links folgen.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="border-top border-white-25 mt-5 pt-3 text-white-50 small d-flex flex-column flex-lg-row justify-content-between gap-2">
      <span>© {{ brand }}. Automatisiert erneuert mit Agentic WebRenewal.</span>
      <span>Framework: {{ framework.name | title }}</span>
    </div>
  </div>
</footer>
